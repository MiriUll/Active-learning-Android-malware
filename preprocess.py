from config import *
from feature_generator import Feature_Mapping_Generator
from analysed_apk import AnalysedAPK
import os
import random


def preprocess():
    # 1. Analyse Apks and split into training and test set
    mal_train, mal_test = load_and_label_data(maleware_path, 1)
    good_train, good_test = load_and_label_data(goodware_path, 0)
    training_data = mal_train + good_train
    random.shuffle(training_data)
    for a in training_data:
        print(a.package, a.label)

    # Setup feature mapping
    generate_feature_mapping(training_data)
    return training_data, random.shuffle(mal_test+good_test)


def load_and_label_data(apkpath, label, percentage_test=0.2):
    """
    generate labeled list of data
    :param apkpath: path to apk dir
    :param label: label for data
    :param percentage_test: proportion of test and training data, value with leading 0
    :return:
    """
    print('************************\nAnalising APKs')
    apps = os.listdir(apkpath)
    num_test = len(apps) * percentage_test
    print num_test, 'apps are test apps'
    data_test = []
    while len(data_test) < num_test:
        app = apps.pop(random.randint(0, len(apps)-1))
        data_test.append(AnalysedAPK(os.path.join(apkpath, app), label))
    data_train = []
    while len(apps) > 0:
        app = apps.pop(random.randint(0, len(apps)-1))
        data_train.append(AnalysedAPK(os.path.join(apkpath, app), label))
    return data_train, data_test


def generate_feature_mapping(data):
    print('************************\nGenerating Feature Mapping')
    fg = Feature_Mapping_Generator()
    fg.retrieve_source_codes(data)
    print('found source code: ', len(fg.source_code))
    fg.build_feature_mapping()
    fg.export_mapping(feature_mapping_path)

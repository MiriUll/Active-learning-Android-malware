import argparse
import json
import pandas as pd
import os
import csv
from utils.config import *

# This file compares results in a csv file

parser = argparse.ArgumentParser(prog="compare_results.py",
                                 description="Visualize results from training")
parser.add_argument("-r", "--result", nargs='+', help="path to result json", required=True)
parser.add_argument("-c", "--compare", help="path to compare result", required=False)
parser.add_argument("-a", "--argument", help="argument to compare", required=False)
arguments = parser.parse_args()


def append_csv(source, to, mode='a', header=''):
    """
    append existing csv file to csv file
    :param source: source file
    :param to: file to append
    :param mode: mode to open file
    :param header: header of file
    :return:
    """
    with open(to, mode) as f:
        writer = csv.writer(f)
        writer.writerow([header])
        reader = csv.reader(open(source))
        for row in reader:
            writer.writerow(row)


def generate_single_csv(origin, path, sort=True):
    """
    generate a single csv file
    :param origin: data for file
    :param path: path to store file
    :param sort: defines if header should be sorted
    :return:
    """
    df = pd.DataFrame(origin)
    if sort:
        df = df.reindex(sorted(df.columns, key=lambda x: int(x) if x is not 'inactive' else x), axis=1)
    df.to_csv(path)


def result_to_csv_table():
    """
    save results in csv file
    """
    r = arguments.result[0]
    store_result_path = results_folder + r.rsplit('/', 1)[1].rsplit('.', 1)[0] + '/'
    print(store_result_path)
    if not os.path.exists(store_result_path):
        os.mkdir(store_result_path)
    result = json.load(open(r))

    # show training results
    generate_single_csv(add_key_to_dict(result['active']['training'], 'inactive',result['inactive']['training']),
                        store_result_path + 'training.csv')
    # show test results
    generate_single_csv(add_key_to_dict(result['active']['test'], 'inactive', result['inactive']['test']),
                        store_result_path + 'test.csv')
    # show arguments
    generate_single_csv({'arguments': result['arguments']}, store_result_path + 'arguments.csv', sort=False)
    # generate combined csv
    append_csv(store_result_path + 'training.csv', store_result_path + 'visualization.csv', 'w+', 'Training metrics')
    append_csv(store_result_path + 'test.csv', store_result_path + 'visualization.csv', header='Test metrics')
    append_csv(store_result_path + 'arguments.csv', store_result_path + 'visualization.csv')


def compare_arguments_for_path(result, compare, tag):
    """
    compare arguments of different results to define stor name
    :param result: results dict
    :param compare: results to compare
    :param tag: tag of store
    :return:
    """
    store_path = results_folder + tag
    for a in result['arguments']:
        if not result['arguments'][a] == compare['arguments'][a]:
            store_path += '_' + a.capitalize() + '-' + str(result['arguments'][a]).capitalize() + '-' + str(
                compare['arguments'][a]).capitalize()
    store_path += '/'
    return store_path


def combine_dicts(result, compare, appendix_res='_res', appendix_comp='_comp'):
    """
    combine two result dicts
    :param result: result dict
    :param compare: result dict to compare
    :param appendix_res: appendix of header values for result dict
    :param appendix_comp: appendix of header values for compare dict
    :return: combine dict
    """
    for key in list(result.keys()):
        result[key + appendix_res] = result.pop(key)
    for key in list(compare.keys()):
        result[key + appendix_comp] = compare[key]
    return result


def add_key_to_dict(dic, addition_label, addition):
    """
    add single key to existing dict
    :param dic: dict
    :param addition_label: additinal label
    :param addition: additional data
    :return: dict
    """
    dic[addition_label] = addition
    return dic


def compare_results():
    """
    compare results in csv file
    :return:
    """
    result = json.load(open(arguments.result))
    compare = json.load(open(arguments.compare))
    store_path = compare_arguments_for_path(result, compare, 'compare')

    if not os.path.exists(store_path):
        os.mkdir(store_path)

    training = combine_dicts(add_key_to_dict(result['active']['training'], 'inactive', result['inactive']['training']),
                             add_key_to_dict(compare['active']['training'], 'inactive', compare['inactive']['training']))
    generate_single_csv(training, store_path + 'training.csv', sort=False)

    test = combine_dicts(add_key_to_dict(result['active']['test'], 'inactive', result['inactive']['test']),
                         add_key_to_dict(compare['active']['test'], 'inactive', compare['inactive']['test']))
    generate_single_csv(test, store_path + 'test.csv')

    generate_single_csv({'result': result['arguments'], 'compare': compare['arguments']}, store_path + 'arguments.csv',
                        sort=False)
    # generate combined csv
    append_csv(store_path + 'training.csv', store_path + 'visualization.csv', 'w+', 'Training metrics')
    append_csv(store_path + 'test.csv', store_path + 'visualization.csv', header='Test metrics')
    append_csv(store_path + 'arguments.csv', store_path + 'visualization.csv')


def combine_schema_dicts(mode):
    """
    combine dicts with different schemes
    :param mode: metrics to combine
    :return: combined dict
    """
    metrics_dict = {}
    for res in arguments.result:
        result = json.load(open(res))
        schema = result['arguments'][arguments.argument]
        metrics_dict['inactive_' + schema] = result['inactive'][mode]
        max_it = max(int(k) for k in result['active'][mode].keys())
        metrics_dict[schema] = result['active'][mode][str(max_it)]
    return metrics_dict


def compare_specific_argument():
    """
    compare one sepcific argument in csv file
    """
    store_path = results_folder + 'compare_' + arguments.argument + '/'
    if not os.path.exists(store_path):
        os.mkdir(store_path)
    metrics_training = combine_schema_dicts('training')
    generate_single_csv(metrics_training, store_path + 'training.csv', sort=False)
    metrics_test = combine_schema_dicts('test')
    generate_single_csv(metrics_test, store_path + 'test.csv', sort=False)

    arguments_dict = {}
    for res in arguments.result:
        result = json.load(open(res))
        arguments_dict[result['arguments'][arguments.argument]] = result['arguments']
    generate_single_csv(arguments_dict, store_path + 'arguments.csv', sort=False)

    # generate combined csv
    append_csv(store_path + 'training.csv', store_path + 'visualization.csv', 'w+', 'Training metrics')
    append_csv(store_path + 'test.csv', store_path + 'visualization.csv', header='Test metrics')
    append_csv(store_path + 'arguments.csv', store_path + 'visualization.csv')


if __name__ == '__main__':
    if arguments.argument is not None:
        compare_specific_argument()
    elif arguments.compare is None:
        result_to_csv_table()
    else:
        compare_results()

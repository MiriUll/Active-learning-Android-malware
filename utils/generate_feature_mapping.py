# coding=utf-8
from __future__ import print_function
from Oedipus.gadgets.feature_extraction import extractTFIDFMemoryFriendly, extractMemoryFriendlyTFIDFOnTrained
import os
from androguard.misc import AnalyzeAPK

# directory where data is stored
source_code_dir = '/home/miriam/malwaredetection/utils/source_codes/tfidf_filtered_500/'
# path to store feature mapping
feature_mapping = '/home/miriam/malwaredetection/utils/source_codes/tfidf_filtered_500/feature_mapping'

# Paths of training and test apps to extract source codes from
training_data_path = ['/home/aesalem/Research/Android/Datasets/Malware/AMD/amd_data/',
                      '/home/aesalem/Research/Android/Datasets/Goodware/google_play/']
test_data_path = ['/home/aesalem/Research/Android/Datasets/Malware/AndroZoo_Piggybacking/piggybacked/',
                  '/home/aesalem/Research/Android/Datasets/Malware/AndroZoo_Piggybacking/original/']

feature_training = [source_code_dir + 'amd/',
                    source_code_dir + 's.home.aesalem.Research.Android.Datasets.Goodware.google_play./']


def retrieve_source_codes_from_datasets():
    # Analyse all data and save code to file
    if not os.path.exists(source_code_dir):
        os.mkdir(source_code_dir)
    for path in test_data_path:
        subpath = source_code_dir + '/s' + (path.replace('/', '.').replace(':', ''))
        if not os.path.exists(subpath):
            os.mkdir(subpath)
        print('analysing apps in path', path)
        for data in os.listdir(path):
            if os.path.isfile(path + data):
                print(data)
                retrieve_source_code(path + data, subpath)


def generate_feature_mapping():
    """
    Train tfidf vectorizer with training data
    """
    extractTFIDFMemoryFriendly(source_code_dir, 'txt', maxfeatures=500, export=True, mapping_path=feature_mapping)


def gen_features_from_mapping(path):
    """
    Reuse existing vectorizer to generate test features
    :param path: path to test data
    """
    extractMemoryFriendlyTFIDFOnTrained(path, 'txt',
                                        '/home/miriam/malwaredetection/utils/source_codes/tfidf_filtered_500/'
                                        'corpus_1553440119.txt',
                                        '/home/miriam/malwaredetection/utils/source_codes/tfidf_filtered_500/'
                                        'feature_mapping',
                                        500)


def retrieve_source_code(path, subpath):
    """
    retrieve source codes from dataset path and store as files
    :param path: dataset path
    :param subpath: path to single apk
    :return:
    """
    try:
        # analyse apk with androguard
        a, d, _ = AnalyzeAPK(path)
        # do not re-analyse files
        if os.path.isfile(subpath + '/' + a.get_package() + '.txt'):
            # only analyse new apks to save time
            print('file exists')
            return
        with open(subpath + '/' + a.get_package() + '.txt', 'w+') as code_file:
            for dalvik in d:
                for c_name in dalvik.get_classes_names():
                    if c_name.startswith('L' + a.package.replace('.', '/')):
                        # retrieve java code
                        # print(dalvik.get_class(c_name).get_source())
                        for method in dalvik.get_class(c_name).get_methods():
                            # method = m.get_method()
                            code = ""
                            byte_code = method.get_code()
                            if byte_code is not None:
                                byte_code = byte_code.get_bc()
                                for i in byte_code.get_instructions():
                                    code += i.get_name() + ' ' + i.get_output() + '\n'
                            code_file.write(code.encode('utf-8') + '\n')
    except Exception:
        print('ignoring file')


if __name__ == "__main__":
    retrieve_source_codes_from_datasets()
    generate_feature_mapping()
    gen_features_from_mapping(
        '/home/miriam/malwaredetection/utils/source_codes/tfidf_filtered_500/s.home.aesalem.Research.Android.Datasets.'
        'Malware.AndroZoo_Piggybacking.original./')
    gen_features_from_mapping(
        '/home/miriam/malwaredetection/utils/source_codes/tfidf_filtered_500/s.home.aesalem.Research.Android.Datasets.'
        'Malware.AndroZoo_Piggybacking.piggybacked./')

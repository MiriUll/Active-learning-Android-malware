from __future__ import print_function
from config import *
from Oedipus.gadgets.feature_extraction import extractTFIDFMemoryFriendly, extractMemoryFriendlyTFIDFOnTrained
import os, sys
from androguard.misc import AnalyzeAPK

sys.path.insert(0, aion_path)
from Aion.utils.db import *

# source_code_dir = '/home/anschutzm/PycharmProjects/malewaredetection/utils/source_codes'
source_code_dir = '/home/miriam/malwaredetection/utils/source_codes/training_subset/'
feature_mapping = '/home/miriam/malwaredetection/utils/source_codes/training_subset/feature_mapping'
# feature_mapping = feature_mapping_path
#training_data_path = ['/home/aesalem/Research/Android/Datasets/Malware/AMD/amd_data/']
training_data_path = ['/home/aesalem/Research/Android/Datasets/Goodware/google_play/']
source_code_dir_test = '/home/miriam/malwaredetection/utils/source_codes/training_subset_test/'
#test_data_path = ['/home/aesalem/Research/Android/Datasets/Malware/MalGenome/genome/',
test_data_path = ['/home/aesalem/Research/Android/Datasets/Malware/AndroZoo_Piggybacking/piggybacked/',
                  '/home/aesalem/Research/Android/Datasets/Malware/AndroZoo_Piggybacking/original/']

feature_training = [source_code_dir + 'amd/', source_code_dir + 's.home.aesalem.Research.Android.Datasets.Goodware.google_play./']


def main():
    # 1. Analyse all data and save code to file
    if not os.path.exists(source_code_dir_test):
        os.mkdir(source_code_dir_test)
    for path in test_data_path:
        subpath = source_code_dir_test + '/s' + (path.replace('/', '.').replace(':', ''))
        if not os.path.exists(subpath):
            os.mkdir(subpath)
        print('analysing apps in path', path)
        for data in os.listdir(path):
            if os.path.isfile(path + data):
                print(data)
                retrieve_source_code(path + data, subpath)


def generate_feature_mapping():
    extractTFIDFMemoryFriendly(feature_training, 'txt', maxfeatures=500, export=True, mapping_path=feature_mapping)


def gen_features_from_mapping(path):
    extractMemoryFriendlyTFIDFOnTrained(path, 'txt',
                                        '/home/miriam/malwaredetection/utils/corpus_1549372073.txt',
                                        '/home/miriam/malwaredetection/utils/source_codes/training_piggybacking/p_feature_mapping',
                                        500)


def retrieve_source_code(path, subpath):
    try:
        a, d, _ = AnalyzeAPK(path)
        # do not re-analyse files
        if os.path.isfile(subpath + '/' + a.get_package() + '.txt'):
            print('file exists')
            return
        with open(subpath + '/' + a.get_package() + '.txt', 'w+') as code_file:
            for dalvik in d:
                for c_name in dalvik.get_classes_names():
                    if c_name.startswith('L' + a.package.replace('.', '/')):
                        # retrieve java code
                        # print(dalvik.get_class(c_name).get_source())
                        for method in dalvik.get_class(c_name).get_methods():
                            # method = m.get_method()
                            code = ""
                            byte_code = method.get_code()
                            if byte_code is not None:
                                byte_code = byte_code.get_bc()
                                for i in byte_code.get_instructions():
                                    code += i.get_name() + ' ' + i.get_output() + '\n'
                            code_file.write(code.encode('utf-8') + '\n')
    except Exception:
        print('ignoring file')


if __name__ == "__main__":
    main()
    # gen_features_from_mapping()
    # gen_features_from_mapping('/home/miriam/malwaredetection/utils/source_codes/training_piggybacking/s.home.aesalem.Research.Android.Datasets.Malware.AMD.amd_data./')
    # gen_features_from_mapping('/home/miriam/malwaredetection/utils/source_codes/training_piggybacking/s.home.aesalem.Research.Android.Datasets.Goodware.google_play./')
    # gen_features_from_mapping('/home/miriam/malwaredetection/utils/source_codes/s.home.aesalem.Research.Android.Datasets.Malware.AndroZoo_Piggybacking.original./')
    # gen_features_from_mapping('/home/miriam/malwaredetection/utils/source_codes/s.home.aesalem.Research.Android.Datasets.Malware.AndroZoo_Piggybacking.piggybacked./')
    # gen_features_from_mapping('/home/miriam/malwaredetection/utils/source_codes/s.home.aesalem.Research.Android.Datasets.Malware.MalGenome.genome./')

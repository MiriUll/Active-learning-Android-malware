from __future__ import print_function
from config import *
import os
from androguard.misc import AnalyzeAPK
from Oedipus.gadgets.feature_extraction import extractTFIDFMemoryFriendly, extractMemoryFriendlyTFIDFOnTrained
source_code_dir = os.curdir + '/source_codes'
apk_paths = [goodware_path, maleware_path]


def main():
    # 1. Analyse all data and save code to file
    if not os.path.exists(source_code_dir):
        os.mkdir(source_code_dir)
        for path in apk_paths:
            print('analysing apps in path', path)
            for data in os.listdir(path):
                print(data)
                retrieve_source_code(path + data)
    extractTFIDFMemoryFriendly(source_code_dir, 'txt', maxfeatures=500, export=True, mapping_path=feature_mapping_path)

def gen_features_from_mapping():
    extractMemoryFriendlyTFIDFOnTrained(source_code_dir, 'txt',
                                    'C:\Users\manschuetz\PycharmProjects\malewaredetection\utils\corpus_1547112460_txt',
                                    'C:\Users\manschuetz\PycharmProjects\malewaredetection\utils\\feature_mapping', 500)

def retrieve_source_code(path):
    a, d, _ = AnalyzeAPK(path)
    with open(source_code_dir + '/' + a.get_package() + '.txt', 'w+') as code_file:
        for dalvik in d:
            for c_name in dalvik.get_classes_names():
                if c_name.startswith('L' + a.package.replace('.', '/')):
                    # retrieve java code
                    # print(dalvik.get_class(c_name).get_source())
                    for method in dalvik.get_class(c_name).get_methods():
                        # method = m.get_method()
                        code = ""
                        byte_code = method.get_code()
                        if byte_code is not None:
                            byte_code = byte_code.get_bc()
                            for i in byte_code.get_instructions():
                                code += i.get_name() + ' ' + i.get_output()
                        code_file.write(code + '\n')


if __name__ == "__main__":
    #main()
    gen_features_from_mapping()

from __future__ import print_function
from utils.config import *
from utils.old_callgraph_windows.feature_generator import Feature_Mapping_Generator
from utils.old_callgraph_windows.analysed_apk import AnalysedAPK
import os, sys
import random
import pickle
sys.setrecursionlimit(5000)


def preprocess(save_analysis=False):
    # 1. Analyse Apks and split into training and test set
    training_data, test_data = generate_data_sets()
    for a in training_data:
        print(a.package, a.label)
    if save_analysis:
        # export analysed apks and their graphs
        save_analysis_to_path(export_path + 'training_data', training_data)
        save_analysis_to_path(export_path + 'test_data', test_data)
    # Setup feature mapping
    generate_feature_mapping(training_data+test_data)
    return training_data, test_data


def save_analysis_to_path(folder, apps):
    if not os.path.exists(folder):
        os.mkdir(folder)
    for a in apps:
        print('Exporting', a.package)
        with open(folder+'/'+a.package+'.pkl', 'wb') as fh:
            pickle.dump(a, fh)
        a.export_graph(folder+'/'+a.package+'_graph.pkl')


def generate_data_sets():
    mal_train, mal_test = load_and_label_data(maleware_path, 1)
    good_train, good_test = load_and_label_data(goodware_path, 0)
    training_data = mal_train + good_train
    test_data = mal_test + good_test
    random.shuffle(training_data)
    random.shuffle(test_data)
    return training_data, test_data


def load_and_label_data(apkpath, label, percentage_test=0.2):
    """
    generate labeled list of data
    :param apkpath: path to apk dir
    :param label: label for data
    :param percentage_test: proportion of test and training data, value with leading 0
    :return:
    """
    print('************************\nAnalising APKs')
    apps = os.listdir(apkpath)
    num_test = len(apps) * percentage_test
    print(num_test, 'apps are test apps')
    data_test = []
    while len(data_test) < num_test:
        try:
            app = apps.pop(random.randint(0, len(apps)-1))
            data_test.append(AnalysedAPK(os.path.join(apkpath, app), label))
        except Exception as e:
            # ignore apps that crash
            print(e)
            print("ignoring app")
    data_train = []
    for a in apps:
        try:
            app = AnalysedAPK(os.path.join(apkpath, a), label)
            # some apps are corrupt and have empty call graph
            if not len(app.graph) < 1:
                data_train.append(app)
        except:
            print("ignoring app")
    return data_train, data_test


def generate_feature_mapping(data):
    print('************************\nGenerating Feature Mapping')
    fg = Feature_Mapping_Generator()
    fg.retrieve_source_codes(data)
    print('found source code: ', len(fg.source_code))
    fg.build_feature_mapping()
    fg.export_mapping(feature_mapping_path)


if __name__ == '__main__':

    pass

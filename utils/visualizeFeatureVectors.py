#!/usr/bin/python
import sys
import numpy
from utils import load_features_from_path
from config import *
sys.path.insert(0, aion_path)
import Aion
from Aion.conf.config import *

Aion.conf.config.LOG_FILE = aion_log_file

from Aion.data_generation.reconstruction.Numerical import *
from visualizeData import *
from Aion.utils.graphics import *
from Aion.utils.data import *

import pickledb
import glob, os, argparse, hashlib

def defineArguments():
    parser = argparse.ArgumentParser(prog="visualizeFeatureVectors.py", description="A tool to reduce the dimensionality of data points and visualize them in 2- or 3-D.")
    parser.add_argument("-p", "--datasetpath", nargs='+', help="The directory containing the feature vectors", required=True)
    parser.add_argument("-l", "--label", nargs='+', required=True)
    parser.set_defaults(compare_virus_total=True, ignore_ambiguous=True)
    parser.add_argument("-v", "--compare_virus_total", help="disable virus total comparation", required=False,
                        default=True, dest='compare_virus_total', action='store_false')
    parser.add_argument("-s", "--labeling_schema", help="labeling schema for vt labels", required=False, default="zero",
                        choices=["zero", "ambiguous", "fifty_percent"])
    parser.add_argument("-a", "--algorithm", help="The dimensionality reduction algorithm to use", required=False, default="tsne", choices=["tsne", "pca"])
    parser.add_argument("-d", "--dimensionality", help="The target dimensionality to which the feature vectors are projected", required=False, default="2", choices=["2", "3"])
    parser.add_argument("-si", "--figuresize", help="The size of the Plotly figure", required=False, default="(1024, 1024)")
    return parser

def main():
    argumentParser = defineArguments()
    arguments = argumentParser.parse_args()
    print(arguments.label)
    # Retrieve the data
    fileExtension = "tfidf"
    appNames = []
    X, y = [], []
    for i, path in enumerate(arguments.datasetpath):
        print(path)
        #allFiles += glob.glob("%s/*.%s" % (path, fileExtension))
        appNames += ([f.rsplit('/', 1)[1].strip('.tfidf') for f in glob.glob(path + '*.tfidf')])
        x_p, y_p = load_features_from_path(path, int(arguments.label[i]), arguments.labeling_schema, arguments.compare_virus_total, arguments.ignore_ambiguous)
        X += x_p
        y += y_p
    if len(X) < 1:
        prettyPrint("Could not retrieve any \".%s\" files from the dataset directory \"%s\". Exiting" % (fileExtension, arguments.datasetpath), "warning")
        return False
    prettyPrint("Successfully retrieved %s \".%s\" files from the dataset directory \"%s\"" % (len(X), fileExtension, arguments.datasetpath))
    X = numpy.array(X)
    y = numpy.array(y)
    # Perform visualization
    figureTitle = "Dynamic Introspy features in %sD" % arguments.dimensionality
    reduceAndVisualize(X, y, int(arguments.dimensionality), arguments.algorithm, eval(arguments.figuresize), figureTitle, appNames)

    return True


if __name__ == "__main__":
    main()

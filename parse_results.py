import argparse
import json
import pandas as pd
import os
import csv
from utils.config import *

parser = argparse.ArgumentParser(prog="parse_results.py",
                                 description="Visualize results from training")
parser.add_argument("-r", "--result", help="path to result json", required=True)
arguments = parser.parse_args()
# results = ['/home/anschutzm/PycharmProjects/malewaredetection/results/inactive_naive_bayes-Compare_virus_totalFalse-Labeling_schemaAmbiguous.json']


def append_csv(source, to, mode='a', header=''):
    with open(to, mode) as f:
        writer = csv.writer(f)
        writer.writerow([header])
        reader = csv.reader(open(source))
        for row in reader:
            writer.writerow(row)


def my_table():
    r = arguments.result
    store_result_path = results_folder + r.rsplit('/', 1)[1].split('.')[0] + '/'
    if not os.path.exists(store_result_path):
        os.mkdir(store_result_path)
    result = json.load(open(r))

    # show training results
    training_dic = result['active']['training']
    training_dic['inactive'] = result['inactive']['training']
    training = pd.DataFrame(training_dic)
    training = training.reindex(sorted(training.columns, key=lambda x: int(x) if x is not 'inactive' else x), axis=1)
    training.to_csv(store_result_path + 'training.csv')

    # show test results
    test_dic = result['active']['test']
    test_dic['inactive'] = result['inactive']['test']
    test = pd.DataFrame(test_dic)
    test = test.reindex(sorted(test.columns, key=lambda x: int(x) if x is not 'inactive' else x), axis=1)
    test.to_csv(store_result_path + 'test.csv')

    # show arguments
    args = pd.DataFrame({'arguments': result['arguments']})
    args.to_csv(store_result_path + 'arguments.csv')
    append_csv(store_result_path + 'training.csv', store_result_path + 'visualization.csv', 'w+', 'Training metrics')
    append_csv(store_result_path + 'test.csv', store_result_path + 'visualization.csv', header='Test metrics')
    append_csv(store_result_path + 'arguments.csv', store_result_path + 'visualization.csv')


if __name__ == '__main__':
    my_table()

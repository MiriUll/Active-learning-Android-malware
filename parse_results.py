import json
from json2table import convert
import pandas as pd
import os
import csv
from utils.config import *

table_attributes = {"style": "width:100%", "class": "table table-striped", "border": 1}
align_attributes = {"style": "float: left", "class": "table table-striped", "border": 1, 'align-slef': 'auto'}
build_direction = "TOP_TO_BOTTOM"
results = ['/home/anschutzm/PycharmProjects/malewaredetection/results/inactive_naive_bayes-Compare_virus_totalFalse-Labeling_schemaAmbiguous.json']

def active_vs_inactive():
    for r in results:
        result = json.load(open(r))
        arguments = {'arguments': result['arguments']}
        del result['arguments']

        training = {'active': result['active']['training'], 'inactive': result['inactive']['training']}
        test = {'active': result['active']['test'], 'inactive': result['inactive']['test']}

        tr = result['active']['training']
        tr["caption"] = "fih"
        training_active = convert(tr, table_attributes={"style": 'float: left; width: 50%', "class": "table table-striped", "border": 1, "caption": "Training"})
        training_inactive = convert(result['inactive']['training'], table_attributes={"style": "width: 50%", "class": "table table-striped", "border": 1})
        res = convert(result, build_direction=build_direction, table_attributes=table_attributes)
        args = convert(arguments, table_attributes=table_attributes)

        with open('results/parsed_result.html', 'w+') as html_file:
            html_file.write(convert({'training': {'active': None, 'inactive': None}}, build_direction='TOP_TO_BOTTOM', table_attributes=table_attributes))

            #html_file.write(training_active)
            html_file.write('<div class="full-width">' + training_active + '\n' + training_inactive + '</div>')
            html_file.write(convert(test, table_attributes=table_attributes))
            html_file.write(args)


def append_csv(source, to, mode='a', header=''):
    with open(to, mode) as f:
        writer = csv.writer(f)
        writer.writerow([header])
        reader = csv.reader(open(source))
        for row in reader:
            writer.writerow(row)


def my_table():
    for r in results:
        export_path = results_folder + r.rsplit('/', 1)[1].split('.')[0] + '/'
        if not os.path.exists(export_path):
            os.mkdir(export_path)
        result = json.load(open(r))

        #show training results
        training_dic = result['active']['training']
        training_dic['inactive'] = result['inactive']['training']
        training = pd.DataFrame(training_dic)
        training.to_csv(export_path + 'training.csv')

        #show test results
        test_dic = result['active']['test']
        test_dic['inactive'] = result['inactive']['test']
        test = pd.DataFrame(test_dic)
        test.to_csv(export_path + 'test.csv')

        #show arguments
        args = pd.DataFrame({'arguments': result['arguments']})
        args.to_csv(export_path + 'arguments.csv')

        append_csv(export_path + 'training.csv', export_path + 'visualization.csv', 'w+', 'Training metrics')
        append_csv(export_path + 'test.csv', export_path + 'visualization.csv', header='Test metrics')
        append_csv(export_path + 'arguments.csv', export_path + 'visualization.csv')



if __name__ == '__main__':
    #active_vs_inactive()
    my_table()
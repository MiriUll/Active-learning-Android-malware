import argparse
import json
import pandas as pd
import os
import csv
from utils.config import *

parser = argparse.ArgumentParser(prog="parse_results.py",
                                 description="Visualize results from training")
parser.add_argument("-r", "--result", help="path to result json", required=True)
parser.add_argument("-c", "--compare", help="path to compare result", required=False)
arguments = parser.parse_args()


# results = ['/home/anschutzm/PycharmProjects/malewaredetection/results/inactive_naive_bayes-Compare_virus_totalFalse-Labeling_schemaAmbiguous.json']


def append_csv(source, to, mode='a', header=''):
    with open(to, mode) as f:
        writer = csv.writer(f)
        writer.writerow([header])
        reader = csv.reader(open(source))
        for row in reader:
            writer.writerow(row)


def generate_single_csv(origin, path, addition_label=None, addition=None, sort=True):
    if addition_label:
        origin[addition_label] = addition
    df = pd.DataFrame(origin)
    if sort:
        df = df.reindex(sorted(df.columns, key=lambda x: int(x) if x.isdigit() else x), axis=1)
    df.to_csv(path)


def result_to_csv_table():
    r = arguments.result
    store_result_path = results_folder + r.rsplit('/', 1)[1].split('.')[0] + '/'
    if not os.path.exists(store_result_path):
        os.mkdir(store_result_path)
    result = json.load(open(r))

    # show training results
    generate_single_csv(result['active']['training'], store_result_path + 'training.csv', 'inactive',
                        result['inactive']['training'])
    # show test results
    generate_single_csv(result['active']['test'], store_result_path + 'test.csv', 'inactive',
                        result['inactive']['test'])
    # show arguments
    generate_single_csv({'arguments': result['arguments']}, store_result_path + 'arguments.csv', sort=False)
    # generate combined csv
    append_csv(store_result_path + 'training.csv', store_result_path + 'visualization.csv', 'w+', 'Training metrics')
    append_csv(store_result_path + 'test.csv', store_result_path + 'visualization.csv', header='Test metrics')
    append_csv(store_result_path + 'arguments.csv', store_result_path + 'visualization.csv')


def compare_arguments_for_path(result, compare):
    store_path = results_folder + 'compare'
    for a in result['arguments']:
        if result['arguments'][a] is not compare['arguments'][a]:
            store_path += '_' + a.capitalize() + '-' + str(result['arguments']).capitalize() + '-' + str(
                compare['arguments']).capitalize()
    return store_path


def combine_dicts(result, compare, addition_label=None, addition=None, appendix_res='_res', appendix_comp='_comp'):
    if addition_label:
        result[addition_label] = result[addition]
        compare[addition_label] = compare[addition]
    for key in result:
        result[key + appendix_res] = result.pop(key)
    for key in compare:
        result[key + appendix_comp] = compare[key]
    return result


def compare_results():
    result = json.load(open(arguments.result))
    compare = json.load(open(arguments.compare))
    store_path = compare_arguments_for_path(result, compare)

    if not os.path.exists(store_path):
        os.mkdir(store_path)

    training = combine_dicts(result['active']['training'], compare['active']['training'], 'inactive', ['inactive']['training'])
    generate_single_csv(training, store_path + 'training.csv')

    test = combine_dicts(result['active']['test'], compare['active']['test'], 'inactive', ['inactive']['test'])
    generate_single_csv(test, store_path + 'test.csv')

    generate_single_csv({'result': result['arguments'], 'compare': compare['arguments']}, store_path + 'arguments.csv', sort=False)
    # generate combined csv
    append_csv(store_path + 'training.csv', store_path + 'visualization.csv', 'w+', 'Training metrics')
    append_csv(store_path + 'test.csv', store_path + 'visualization.csv', header='Test metrics')
    append_csv(store_path + 'arguments.csv', store_path + 'visualization.csv')


if __name__ == '__main__':
    if not hasattr(arguments, 'compare'):
        result_to_csv_table()
    else:
        compare_results()

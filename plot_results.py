import argparse
import json
import matplotlib.pyplot as plt
from cycler import cycler

plt.rc('axes', prop_cycle=(cycler('color', ['r', 'g', 'b', 'y']) +
                           cycler('linestyle', ['-', '--', ':', '-.'])))

parser = argparse.ArgumentParser(prog="parse_results.py",
                                 description="Visualize results from training")
parser.add_argument("-r", "--result", help="path to result json", required=True)
parser.add_argument("-c", "--compare", help="path to compare result", nargs='+', required=False, default='inactive')
parser.add_argument("-m", "--metric", help="the metric to print", required=False, default="accuracy",
                    choices={'accuracy', 'f1score', 'precision', 'recall', 'specificity'})
parser.add_argument("-t", "--training", help="plot training or test results", required=False, default="training",
                    choices=["training", "test"])
arguments = parser.parse_args()


def metrics_to_list(result):
    sub_dic = result['active'][arguments.training]
    metrics = []
    for res in sub_dic:
        metrics.append(sub_dic[res][arguments.metric])
    return metrics


def find_argument_difference(result, compare):
    diff = []
    for a in result['arguments']:
        if a == 'training: num benign' or a == 'training: num malicious':
            continue
        if not result['arguments'][a] == compare['arguments'][a]:
            diff.append(a)
    return diff


def label_from_diff_arguments(result, different_arguments):
    res_label = ""
    for arg in different_arguments:
        res_label += arg + ": " + str(result['arguments'][arg]) + ' '
    return res_label


def plot_result():
    result = json.load(open(arguments.result))

    metrics = metrics_to_list(result)

    if arguments.compare == 'inactive':
        plt.plot(metrics, label='active')
        plt.axhline(y=result['inactive'][arguments.training][arguments.metric], color='g', linestyle='--', label='inactive')

        ymax = max(metrics)
        ypos_max = metrics.index(ymax)
        ymin = min(metrics)
        ypos_min = metrics.index(ymin)
        plt.annotate(ymax, xy=(ypos_max, ymax), xytext=(ypos_max, ymax + 0.1),
                     arrowprops=dict(facecolor='black', arrowstyle='->'))
        plt.annotate(ymin, xy=(ypos_min, ymin), xytext=(ypos_min, ymin - 0.1),
                     arrowprops=dict(facecolor='black', arrowstyle='->'))

        save = arguments.result.rsplit('.', 1)[0] + '.png'
    else:
        compare = json.load(open(arguments.compare[0]))
        different_arguments = find_argument_difference(result, compare)
        res_label = label_from_diff_arguments(result, different_arguments)
        plt.plot(metrics, label=res_label)
        for comp in arguments.compare:
            compare = json.load(open(comp))
            metrics_comp = metrics_to_list(compare)
            comp_label = label_from_diff_arguments(compare, different_arguments)
            plt.plot(metrics_comp, label=comp_label)
        save = 'compare_' + ''.join(different_arguments) + '.png'

    plt.xlabel('Iteration')
    plt.ylabel(arguments.training + ' ' + arguments.metric)
    plt.ylim(0.0, 1.0)
    if len(metrics) < 10:
        plt.xticks(range(len(metrics)))

    plt.legend()
    plt.savefig(save)
    plt.show()


if __name__ == '__main__':
    plot_result()

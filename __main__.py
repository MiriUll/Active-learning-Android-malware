from utils.utils import *
from shutil import copyfile
import os
import json
import glob


def gen_package_to_family_mapping():
    path = '/home/aesalem/Research/Android/Datasets/Malware/AMD/amd_data/'
    hash_to_family_mapping = {}
    for fam in os.listdir(path):
        if os.path.isdir(path + fam):
            print(path + fam)
            for app in glob.glob(path + fam + '/**/*.apk'):
                hash_to_family_mapping[(app.rsplit('/', 1)[1]).rsplit('.', 1)[0]] = fam
    with open('hash_to_family_mapping.txt', 'w+') as fh:
        fh.write(json.dumps(hash_to_family_mapping))


if __name__ == '__main__':
    """fg = Feature_Mapping_Generator()
    fg.retrieve_source_codes(maleware_path)
    fg.retrieve_source_codes(goodware_path)
    print(len(fg.source_code))
    fg.build_feature_mapping()
    fg.export_mapping()
    wg = Window_Generator()
    for i in range(0, 50):
        res = wg.next_training_data(True)
        while res is not None:
            res = wg.next_training_data(False)"""
    #training_data, test_data = preprocess.preprocess(True)
    #a = AnalysedAPK(goodware_path + '00a7478f356bfe2d1ed19785f002c1b15f2a3827404e3009c320fdfbf505be2a.apk', 0)
    #a.export_graph(goodware_path + 'export')
    #from networkx import read_edgelist
    #g = read_edgelist(goodware_path + 'export')
    #print g
    #source_code_dir = '/home/miriam/malewaredetection/utils/source_codes/'
    #training_data, y_train = load_features_from_path([source_code_dir + 's.home.aesalem.Research.Android.Datasets.Goodware.google_play./'], 0)
    '''_, _, y_train_orig, y_test_orig, _, _ = load_datasets_ordered(balance_factor=1.0, labeling_schema='original', compare_vt=False, ignore_ambiguous=False)
    _, _, y_train_zero, y_test_zero, _, _ = load_datasets_ordered(balance_factor=1.0, labeling_schema='zero', compare_vt=True, ignore_ambiguous=False)
    _, _, y_train_fifty, y_test_fifty, _, _ = load_datasets_ordered(balance_factor=1.0, labeling_schema='fifty_percent', compare_vt=True, ignore_ambiguous=False)


    for i, l in enumerate(y_test_orig):
        if l == y_test_fifty[i] and l == y_test_zero[i]:
            print(i)'''
    #gen_package_to_family_mapping()
    with open('/home/miriam/malwaredetection/utils/source_codes/training_amd/fixed_subset.txt', 'r') as f:
        for line in f:
            copyfile('/home/miriam/malwaredetection/utils/source_codes/training_amd/s.home.aesalem.Research.Android.Datasets.Malware.AMD.amd_data./' + line + '.txt', '/home/miriam/malwaredetection/utils/source_codes/training_amd/amd_subset')
            copyfile('/home/miriam/malwaredetection/utils/source_codes/training_amd/s.home.aesalem.Research.Android.Datasets.Malware.AMD.amd_data./' + line + '.tfidf', '/home/miriam/malwaredetection/utils/source_codes/training_amd/amd_subset')

from __future__ import print_function
from androguard.misc import AnalyzeAPK
from androguard.core.bytecodes.dvm import EncodedMethod
import networkx as nx
import os


class AnalysedAPK(object):
    def __init__(self, path_to_apk, label):
        if not os.path.isfile(path_to_apk):
            raise ValueError
        self.path = path_to_apk
        self.label = label

        self.package = None
        self.graph = None
        self.entrypoints = None
        self.analyse(path_to_apk)
        self.find_entrypoints()

    def analyse(self, apk):
        a, d, dx = AnalyzeAPK(apk)
        print('Analysing', a.get_package())
        self.package = a.get_package()
        self.graph = dx.get_call_graph(classname='L' + self.package.replace('.', '/') + '/*')
        # not only internal classes are in graph -> delete external nodes
        self.graph.remove_nodes_from([(n if not n.class_name.startswith('L' + self.package.replace('.', '/'))
                                       else None) for n in self.graph.nodes])
        print self.graph.order()

    def find_entrypoints(self):
        entrypoints = []
        for n in self.graph.nodes:
            try:
                next(self.graph.predecessors(n))
            except StopIteration:
                if n.get_class_name().startswith('L' + self.package.replace('.', '/')) and isinstance(n, EncodedMethod):
                    entrypoints.append(n.class_name + '->' + n.name)
        self.entrypoints = iter(entrypoints)

    def __getstate__(self):
        odict = self.__dict__.copy()
        odict['entrypoints'] = list(odict['entrypoints'])
        del odict['graph']
        return odict

    def export_graph(self, path):
        nx.write_gpickle(self.graph, path)

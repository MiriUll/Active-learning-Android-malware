from androguard.misc import AnalyzeAPK
from androguard.core.bytecodes.dvm import EncodedMethod


class AnalysedAPK:

    def __init__(self, path_to_apk, label):
        self.path = path_to_apk
        self.label = label

        self.package = None
        self.graph = None
        self.entrypoints = None
        self.analyse(path_to_apk)
        self.find_entrypoints()

    def analyse(self, apk):
        a, d, dx = AnalyzeAPK(apk)
        print 'Analysing', a.get_package()
        self.package = a.get_package()
        self.graph = dx.get_call_graph(classname='L' + self.package.replace('.', '/') + '/*')

    def find_entrypoints(self):
        entrypoints = []
        for n in self.graph.nodes:
            try:
                next(self.graph.predecessors(n))
            except StopIteration:
                if n.get_class_name().startswith('L'+self.package.replace('.', '/')) and isinstance(n, EncodedMethod):
                    entrypoints.append(n)
        self.entrypoints = iter(entrypoints)

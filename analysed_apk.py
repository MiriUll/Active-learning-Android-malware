from androguard.misc import AnalyzeAPK
from androguard.core.bytecodes.dvm import EncodedMethod
import networkx as nx


class AnalysedAPK:

    def __init__(self, path_to_apk, label):
        self.path = path_to_apk
        self.label = label

        self.package = None
        self.graph = None
        self.entrypoints = None
        self.analyse(path_to_apk)
        self.find_entrypoints()

    def analyse(self, apk):
        a, d, dx = AnalyzeAPK(apk)
        print 'Analysing', a.get_package()
        self.package = a.get_package()
        self.graph = dx.get_call_graph(classname='L' + self.package.replace('.', '/') + '/*')
        # not only internal classes are in graph -> delete external nodes
        self.graph.remove_nodes_from([(n if not n.class_name.startswith('L' + self.package.replace('.', '/'))
                                       else None)for n in self.graph.nodes])
        print self.graph.order()
        #TODO
        if self.graph.order() == 0:
            print('empty graph')

    def find_entrypoints(self):
        entrypoints = []
        for n in self.graph.nodes:
            try:
                next(self.graph.predecessors(n))
            except StopIteration:
                if n.get_class_name().startswith('L'+self.package.replace('.', '/')) and isinstance(n, EncodedMethod):
                    entrypoints.append(n)
        self.entrypoints = iter(entrypoints)

    def __getstate__(self):
        odict = self.__dict__.copy()
        del odict['graph']
        return odict

    def export_graph(self, path):
        mapping = {}
        for n in self.graph.nodes:
            mapping[n] = n.class_name + '->' + n.name
        self.graph = nx.relabel_nodes(self.graph, mapping)
        nx.write_edgelist(self.graph, path)
